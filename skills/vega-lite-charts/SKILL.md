---
name: vega-lite-charts
description: "生成 Vega-Lite 可视化图表，包括饼图、四象限图（波士顿矩阵）、得失分析柱状图、竞争格局分析图（堆叠柱状图）、中国地图。集成 winwin-cli 支持从 Excel/CSV/PDF 等文件直接生成图表。自动根据用户需求和数据特征选择最合适的图表类型，并调用对应子技能生成。"
---

# vega-lite-charts - 图表生成技能

生成 Vega-Lite 可视化图表，支持饼图、四象限图、得失分析柱状图、竞争格局分析图、中国地图。

**核心特性**：
- 根据用户需求和数据特征，自动选择最合适的图表类型
- 集成 winwin-cli，支持从 Excel/CSV/PDF 等文件直接生成图表
- 通过对应的子技能生成高质量的可视化配置

## 子技能

本技能包含以下子技能，每个子技能都有完整的文档和示例：

| 子技能 | 说明 | 详细文档 | 触发场景 |
|--------|------|----------|---------|
| pie-chart | 饼图/环形图，展示各部分占比 | `pie-chart/skill.md` | 占比、构成、百分比 |
| quadrant-chart | 四象限图/波士顿矩阵，品牌分类定位 | `quadrant-chart/skill.md` | 象限分析、分类定位 |
| gain-loss-analysis | 得失分析柱状图（简化版/完整版） | `gain-loss-analysis/skill.md` | 增长对比、正负变化 |
| competitive-landscape | 竞争格局分析图，堆叠柱状图展示多品牌份额对比 | `competitive-landscape/skill.md` | 多品牌对比、竞争格局 |
| china-map | 中国地图，支持省份/城市数据可视化 | `china-map/skill.md` | 地理分布、省份地图 |

**所有图表生成都必须通过子技能完成**，主技能只负责选择合适的子技能。

## 工作流程

### 第零步：数据预处理（使用 winwin-cli）

**当数据源为文件时（Excel/CSV/PDF等），使用 winwin-cli 进行预处理：**

```bash
# 转换 Excel/CSV 为 Markdown 格式
winwin-cli convert data.xlsx -o data.md

# 查看转换结果
cat data.md
```

**优势：**
- 自动识别表格结构
- 保留原始数据格式
- 支持 PDF、Word、PPT、Excel、图片等多种格式
- 快速将文档转换为 AI 友好的 Markdown 格式

**数据预处理后：**
1. 检查数据完整性（缺失值、异常值）
2. 确认数据字段类型（分类/数值）
3. 必要时进行数据清洗和映射
4. 进入图表类型选择阶段

### 第一步：智能选择图表类型

**重要**：必须根据用户需求和数据特征，自动选择最合适的图表类型。

#### 决策树（按优先级）

```
用户需求分析
    │
    ├─ 1️⃣ 用户明确指定图表类型 → 直接使用对应子技能
    │
    ├─ 2️⃣ 用户未指定，按特征判断：
    │
    │   ├─ 【地理位置关键词】
    │   │   关键词：省份、城市、地域、区域、地图、分布、热力图
    │   │   → china-map（中国地图）
    │   │
    │   ├─ 【占比/构成关键词】
    │   │   关键词：占比、构成、百分比、份额、分布
    │   │   数据特征：单个分类字段 + 单个数值字段
    │   │   → pie-chart（饼图）
    │   │
    │   ├─ 【象限/分类关键词】
    │   │   关键词：象限、矩阵、分类、定位、波士顿
    │   │   数据特征：一个分类 + 两个数值（X轴+Y轴指标）
    │   │   → quadrant-chart（四象限图）
    │   │
    │   ├─ 【增长/变化/正负关键词】
    │   │   关键词：增长、变化、对比、得失、同比、涨跌
    │   │   数据特征：数值有正有负
    │   │   → gain-loss-analysis（得失分析）
    │   │   注意：需询问用户选择简化版还是完整版
    │   │
    │   ├─ 【竞争/多品牌对比关键词】
    │   │   关键词：竞争格局、多品牌、市场份额、堆叠、分组
    │   │   数据特征：三个字段（时期 + 品牌 + 份额）
    │   │   → competitive-landscape（竞争格局图）
    │   │
    │   └─ 【模糊不清】
    │       → 询问用户，提供选项让用户选择
    │
    └─ 3️⃣ 调用对应子技能生成图表
```

#### 关键词优先级

当用户输入包含多个类型的关键词时，按以下优先级选择：

1. **地理位置**（最高优先级）
   - 如果提到任何地理位置关键词，优先使用 china-map

2. **图表类型明确指定**
   - 用户明确说"饼图"、"四象限图"等，直接使用指定类型

3. **数据特征判断**
   - 正负值 → gain-loss-analysis
   - 三个字段（时期+品牌+份额）→ competitive-landscape
   - 两个数值字段 → quadrant-chart
   - 单个数值 + 占比关键词 → pie-chart

4. **无法确定**
   - 询问用户，说明各选项的适用场景

#### 详细决策逻辑

完整的决策逻辑参考 `references/chart-selection-guide.md`，包含：
- 详细的触发条件
- 数据特征说明
- 用户表达示例
- 决策流程图
- 常见查询与图表映射

### 第二步：调用对应子技能

**重要**：所有图表生成都必须通过子技能完成。

**调用方式**：
1. 读取对应子技能的 skill.md 文档
2. 查看 examples.json 获取完整示例
3. 根据用户数据修改示例中的 data.values
4. 遵循子技能的核心原则和最佳实践

**子技能调用映射**：

| 场景 | 调用子技能 | 附加操作 |
|------|----------|---------|
| 地理位置可视化 | `china-map/skill.md` | - |
| 占比/构成分析 | `pie-chart/skill.md` | - |
| 象限/分类定位 | `quadrant-chart/skill.md` | - |
| 增长/得失分析 | `gain-loss-analysis/skill.md` | **必须询问**：简化版还是完整版 |
| 竞争格局/多品牌对比 | `competitive-landscape/skill.md` | **建议询问**：百分比堆叠还是绝对值堆叠 |

### 第三步：生成图表规范

遵循以下核心原则：

- **简单优先**：使用默认配置，不要过度定制
  - 颜色：使用 Vega-Lite 默认配色（除非正负值对比或用户明确要求）
  - 图例：饼图禁用图例（`legend: null`），其他图表使用 `orient: "right"`
  - 标签位置：使用子技能推荐的默认值
- 避免在 `mark` 属性中使用表达式
- 在 `encoding` 中使用 `condition` 处理条件逻辑
- 使用 `layer` 处理复杂的标签定位需求
- 确保 Y 轴包含零基线（得失分析）
- 对于 nominal 字段排序：在数据中直接排序 + 设置 `"sort": null`
- 对于多图层：确保所有图层的排序配置一致

### 第四步：验证和调试

- 检查是否使用了不支持的 `expr` 字段
- 确认横纵轴类型正确（nominal vs quantitative）
- 验证颜色比例尺配置（特别是 threshold 类型）
- 确认图例不会遮挡图表内容

## 数据标签显示规则

**重要原则**：图表应尽可能完整显示数据标签和数值，**用户明确说明不需要的才不显示**。

### 默认显示内容

| 图表类型 | 默认显示 |
|---------|---------|
| **四象限图** | 品牌名称标签 + 市场份额/增长率数值 |
| **饼图** | 类别名称 + 百分比数值 |
| **柱状图** | 数值标签（正负区分颜色） |
| **散点图** | 数据点标签 + 数值 |

### 标签位置规则

- **垂直柱状图**：
  - 正值标签显示在柱子**上方**（`baseline: "bottom"`, `dy: -5`）
  - 负值标签显示在柱子**下方**（`baseline: "top"`, `dy: 5`）
  - 需要使用**两个独立图层**配合 `opacity` 条件实现
- **水平柱状图**：数值标签显示在柱子右侧（`align: "left"`, `xOffset: 5`）
- **散点图/四象限图**：品牌/类别名称显示在点旁边，数值显示在点右侧
- **饼图**：
  - 标准饼图：品牌名称显示在饼图外部（`radius` > `outerRadius`）
  - 甜甜圈图：百分比显示在环形区域中间，品牌名显示在外部
  - Tooltip 中显示百分比（需在 data 中添加 total 字段）
- **图表标题**：包含完整说明（横轴/纵轴含义）

## 颜色配置原则

**重要**：遵循"简单优先"原则

- **默认使用 Vega-Lite 内置配色方案**（不要自定义 `scale` 和 `range`）
- **例外情况**：仅在以下情况自定义颜色
  - 正负值对比（得失分析）：使用红色（下降）/绿色（增长）
  - 用户明确要求特定颜色
- **不要在饼图中自定义颜色**：Vega-Lite 默认配色已足够优秀

## 适用场景

### 数据分析场景
- 市场份额分布分析
- 销售构成展示
- 品牌/产品分类定位
- 增长/下跌对比
- 地理数据可视化
- 省份/城市业绩分布

### 数据源支持
- **Excel 文件**（.xlsx, .xls）- 使用 winwin-cli 预处理
- **CSV 文件** - 直接读取或使用 winwin-cli
- **PDF 报告** - 使用 winwin-cli 提取表格数据
- **Word/PPT 文档** - 使用 winwin-cli 转换为 Markdown
- **图片截图** - 使用 winwin-cli OCR 识别表格
- **JSON 数据** - 直接使用

## 快速使用

根据需求选择对应子技能：

- 需要显示占比构成 → 使用 `pie-chart`
- 需要分类定位分析 → 使用 `quadrant-chart`
- 需要正负对比 → 使用 `gain-loss-analysis`（**询问：简化版还是完整版**）
- 需要竞争格局分析/多品牌份额对比 → 使用 `competitive-landscape`
- 需要地理数据可视化/省份分布 → 使用 `china-map`

## 触发词

**图表类型：**
生成饼图、生成四象限图、生成柱状图、市场份额、销售构成、品牌分类、波士顿矩阵、对比增长、得失分析、竞争格局、堆叠柱状图、多品牌份额对比、生成中国地图、省份地图、地域分布、区域数据、冠军地图、热力图

**数据处理：**
根据 xlsx 生成图、从 Excel 生成图表、处理 CSV 数据、转换 PDF 数据、从文件生成可视化

## 通用最佳实践

### 核心原则：简单优先

1. **坐标轴范围配置**（重要）：
   - **避免坐标轴0线贴边**：在坐标轴域外留出10-20%的呼吸空间
   - **四象限图**：横轴（X轴）必须从负值开始（如-0.05），避免Y轴0线贴边
   - **得失分析图**：Y轴域必须包含零点，且上下留出空间
   - 示例：
     ```json
     {
       "width": 1100,
       "height": 650,
       "padding": {"top": 80, "bottom": 80, "left": 80, "right": 150},
       "encoding": {
         "x": {"scale": {"domain": [-0.05, 0.25]}},  // 横轴从负值开始
         "y": {"scale": {"domain": [-0.028, 0.02]}}  // 留出呼吸空间
       }
     }
     ```

2. **图表尺寸和内边距**：
   - **推荐padding**：`{"top": 80, "bottom": 80, "left": 80, "right": 150}`
   - 充足的padding避免标签、标题和图例贴边
   - 多类别（>10个）时，增加宽度：`"width": 1000`
   - 使用 `labelAngle: -45` 避免标签重叠

3. **不要过度配置颜色**：
   - ✅ **推荐**：使用 Vega-Lite 默认配色
     ```json
     {
       "color": {"field": "brand", "type": "nominal", "legend": null}
     }
     ```
   - ❌ **不推荐**：自定义颜色（除非有明确需求）
   - **例外**：正负值对比（得失分析）需要使用阈值颜色

4. **数据标签**：
   - 优先在 `encoding` 中使用条件表达式
   - 避免在 `mark` 属性中使用表达式
   - 使用推荐的默认标签位置（如饼图 `radius: 150`）

5. **零基线**：
   - 对于得失分析，确保 Y 轴包含零点：
   ```json
   {
     "y": {
       "scale": {"domain": [-0.035, 0.016]}
     }
   }
   ```

6. **正负值颜色配置**（得失分析专用）：
   ```json
   {
     "color": {
       "field": "value",
       "type": "quantitative",
       "scale": {
         "domain": [-0.035, 0, 0.016],
         "range": ["#d62728", "#d62728", "#2ca02c"],
         "type": "threshold"
       }
     }
   }
   ```

## 子技能目录

每个子技能都有独立的目录，包含：

```
vega-lite-charts/
├── SKILL.md                      # 主技能文档（本文件）
├── references/
│   └── chart-selection-guide.md  # 图表类型选择指南（详细决策逻辑）
├── pie-chart/
│   ├── SKILL.md                  # 饼图详细文档
│   └── examples.json             # 饼图示例
├── quadrant-chart/
│   ├── SKILL.md                  # 四象限图详细文档
│   └── examples.json             # 四象限图示例
├── gain-loss-analysis/
│   ├── SKILL.md                  # 得失分析详细文档
│   └── examples.json             # 得失分析示例
├── competitive-landscape/
│   ├── SKILL.md                  # 竞争格局分析详细文档
│   └── examples.json             # 竞争格局分析示例
└── china-map/
    ├── SKILL.md                  # 中国地图详细文档
    └── examples.json             # 中国地图示例
```

## 额外资源

### 参考文档

详细的技术文档和决策逻辑：

- **`references/chart-selection-guide.md`** - 图表类型选择指南
  - 完整的决策树和触发条件
  - 用户表达示例和数据特征说明
  - 模糊情况处理建议
  - 常见查询与图表映射表

### 子技能文档

每个子技能都有独立的完整文档，包含：
- 适用场景和触发词
- 核心原则和最佳实践
- 完整的 Vega-Lite JSON 示例
- 常见错误和解决方案
- 使用步骤和注意事项

## 使用 Vega-Lite 编辑器

生成的配置可以在 Vega-Lite 在线编辑器中查看和调试：

https://vega.github.io/editor/

**使用步骤：**
1. 打开编辑器
2. 将生成的 JSON 配置粘贴到左侧编辑器
3. 右侧实时预览图表效果
4. 可在编辑器中进一步调整配置
